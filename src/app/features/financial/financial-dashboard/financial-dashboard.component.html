<div class="financial-container">
  <header class="financial-header">
    <div class="header-title">
      <h1>Painel Financeiro</h1>
      @if (state().selectedCollaboratorId && authService.isAdmin()) {
        <button mat-stroked-button color="accent" (click)="openAddUserDiscountDialog()">Adicionar Taxa Mensal</button>
      }
    </div>
    <div class="filters">
      <!-- Date Range Filter -->
      <mat-form-field appearance="outline">
        <mat-label>Período</mat-label>
        <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
          <input matStartDate formControlName="start" placeholder="Data de início">
          <input matEndDate formControlName="end" placeholder="Data de fim">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <!-- Collaborator Filter (Admin only) -->
      @if (authService.isAdmin()) {
        <mat-form-field appearance="outline">
          <mat-label>Colaborador</mat-label>
          <mat-select [value]="state().selectedCollaboratorId" (selectionChange)="onCollaboratorChange($event.value)">
            <mat-option [value]="null">Visão Geral</mat-option>
            @for (collaborator of state().collaborators; track collaborator.id) {
              <mat-option [value]="collaborator.id">{{ collaborator.full_name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      }
    </div>
  </header>

  <main class="financial-content">
    @if (state().isLoading) {
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    }

    @if (state().error) {
      <div class="error-message">
        <p>{{ state().error }}</p>
      </div>
    }

    @if (!state().isLoading && !state().error) {
      @if (state().selectedCollaboratorId && state().collaboratorFinancials) {
        <app-collaborator-financials [financials]="state().collaboratorFinancials"></app-collaborator-financials>
      } @else {
        <app-financial-overview
          (dataChanged)="loadFinancialData()"
          [receivedInPeriod]="state().receivedInPeriod"
          [overduePayments]="state().overduePayments"
          [upcomingReceivables]="state().upcomingReceivables"
          [inProgressValue]="state().inProgressValue"
          [monthlyChartData]="state().monthlyChartData"
          [detailedEntries]="state().detailedEntries">
        </app-financial-overview>
      }
    }
  </main>
</div>
